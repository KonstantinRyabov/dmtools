---
title: "dmtools_intro"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dmtools_intro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation
```{r install, eval = FALSE}
library(dmtools)
```

## Overview
For checking the dataset from EDC in clinical trials. 
Notice, your dataset should have a postfix( \_V1 ) or a prefix( V1\_ ) in the names of variables. Column names should be unique.

* laboratory - Does the investigator correctly estimate the laboratory analyzes?
* dates - Do all dates correspond to the protocol's timeline?
* sites - If the clinical trial has different lab reference ranges.

## Usage

### laboratory

For laboratory check, you need to create the excel table like in the example.  

* AGELOW - number, >= number
* AGEHIGH - if none, type Inf, <= number  
* SEX - for both sex, use `|`
* LBTEST - What was the lab test name? (can be any convenient name for you)
* LBORRES* - What was the result of the lab test?
* LBNDIND* - How [did/do] the reported values compare within the [reference/normal/expected] range?
* LBORNRLO - What was the lower limit of the reference range for this lab test, >= 
* LBORNRHI - What was the high limit of the reference range for this lab test, <=

*column names without prefix or postfix


```{r refer, echo = FALSE, result = 'asis', warning = FALSE, message = FALSE}
library(knitr)
library(dmtools)
library(dplyr)

refs <- system.file("labs_refer.xlsx", package = "dmtools")
refers <- readxl::read_xlsx(refs)
kable(refers, caption = "lab reference ranges")
```


```{r dataset, echo = FALSE, result = 'asis'}

ID <- c("01", "02", "03")
AGE <- c("19", "20", "22")
SEX <- c("f", "m", "m")
GLUC_V1 <- c("5.5", "4.1", "9.7")
GLUC_IND_V1 <- c("norm", NA, "norm")
AST_V2 <- c("30", "48", "31")
AST_IND_V2 <- c("norm", "norm", "norm")

df <- data.frame(
  ID, AGE, SEX,
  GLUC_V1, GLUC_IND_V1,
  AST_V2, AST_IND_V2,
  stringsAsFactors = F
)

kable(df, caption = "dataset")
```


```{r lab}
# "norm" and "no" it is an example, necessary variable for the estimate, get from the dataset
refs <- system.file("labs_refer.xlsx", package = "dmtools")
obj_lab <- lab(refs, ID, AGE, SEX, "norm", "no")
obj_lab <- obj_lab %>% check(df)

# ok - analysis, which has a correct estimate of the result
obj_lab %>% choose_test("ok")

# mis - analysis, which has an incorrect estimate of the result
obj_lab %>% choose_test("mis")

# skip - analysis, which has an empty value of the estimate
obj_lab %>% choose_test("skip")

# all analyzes 
obj_lab %>% get_result()
```

### dates

For dates check, you need to create the excel table like in the example.

* MINUS, PLUS, VISITDY - parameter of a timeline
* VISITNUM - clinical encounter number, parameter for function e.g. `contains(num_visit)`
* VISIT - protocol-defined description of a clinical encounter (can be any convenient name) 
* STARTDAT - column name of start date, with postfix or prefix
* STARTVISIT - can be any convenient name of start date for you 
* IS_EQUAL - Boolean data type(T/F) to check date equality within a visit
* EQUALDAT - column name for check date's equality, with postfix or prefix

```{r timelines, echo = FALSE, result = 'asis', warning = F, message = FALSE}

dates <- system.file("dates.xlsx", package = "dmtools")
timeline <- readxl::read_xlsx(dates)
kable(timeline, caption = "timeline")
```

```{r dataset_dates, echo = FALSE, result = 'asis'}

id <- c("01", "02", "03")
screen_date_E1 <- c("1991-03-13", "1991-03-07", "1991-03-08")
rand_date_E2 <- c("1991-03-15", "1991-03-11", "1991-03-10")
ph_date_E3 <- c("1991-03-21", "1991-03-16", "1991-03-16")
bio_date_E3 <- c("1991-03-23", "1991-03-16", "1991-03-16")

df <- data.frame(
  id, screen_date_E1, rand_date_E2, ph_date_E3, bio_date_E3,
  stringsAsFactors = F
)

kable(df, caption = "dataset")
```


```{r date}
# use parameter str_date for search columns with dates, default:"DAT"
dates <- system.file("dates.xlsx", package = "dmtools")
obj_date <- date(dates, id, dplyr::contains, dplyr::matches)
obj_date <- obj_date %>% check(df)

# out - dates, which are out of the protocol's timeline
obj_date %>% choose_test("out")

# uneq - dates, which are unequal
obj_date %>% choose_test("uneq")

# ok - correct dates
obj_date %>% choose_test("ok")

# all dates
obj_date %>% get_result()
```
`dplyr::contains` - A function, which select necessary visit or event e.g. dplyr::start_with, dplyr::contains. It works like `df %>% select(contains("E1"))`. You also can use `dplyr::start_with`, works like `df %>% select(start_with("V1"))`

`dplyr::matches` - A function, which select dates from necessary visit e.g. dplyr::matches, dplyr::contains. It works like `visit_one %>% select(contains("DAT"))`, default: `dplyr::contains()`

### sites

If the clinical trial has different sites and lab reference ranges.

```{r refer_sites, echo = FALSE, result = 'asis'}
refs_s01 <- system.file("labs_refer_s01.xlsx", package = "dmtools")
refers_s01 <- readxl::read_xlsx(refs_s01)
kable(refers_s01, caption = "lab reference ranges s01")

refs_s02 <- system.file("labs_refer_s02.xlsx", package = "dmtools")
refers_s02 <- readxl::read_xlsx(refs_s02)
kable(refers_s02, caption = "lab reference ranges s02")
```

```{r dataset_sites, echo = FALSE, result = 'asis'}
SITE <- c("site 01", "site 02")
ID <- c("01", "02")
AGE <- c("19", "20")
SEX <- c("f", "m")
GLUC_V1 <- c("5.5", "4.1")
GLUC_IND_V1 <- c("norm", "no")
AST_V2 <- c("30", "48")
AST_IND_V2 <- c(NA, "norm")

df <- data.frame(
  SITE, ID, AGE, SEX,
  GLUC_V1, GLUC_IND_V1,
  AST_V2, AST_IND_V2,
  stringsAsFactors = F
)

kable(df, caption = "dataset")
```

``` {r sites}
refs_s01 <- system.file("labs_refer_s01.xlsx", package = "dmtools")
refs_s02 <- system.file("labs_refer_s02.xlsx", package = "dmtools")

s01_lab <- lab(refs_s01, ID, AGE, SEX, "norm", "no", site = "site 01")
s02_lab <- lab(refs_s02, ID, AGE, SEX, "norm", "no", site = "site 02")

labs <- list(s01_lab, s02_lab)
labs <- labs %>% check_sites(df, SITE)

# mis - analysis, which has an incorrect estimate of the result
labs %>% test_sites(function (lab) choose_test(lab, "mis"))

# ok - analysis, which has a correct estimate of the result
labs %>% test_sites(function (lab) choose_test(lab, "ok")) 

# skip - analysis, which has an empty value of the estimate
labs %>% test_sites(function (lab) choose_test(lab, "skip"))

# all analyzes
labs %>% test_sites(function (lab) get_result(lab))

# you can combine sites, use |
comb_lab <- lab(refs_s01, ID, AGE, SEX, "norm", "no", site = "site 01|site 02")
comb_labs <- list(comb_lab)

comb_labs <- comb_labs %>% check_sites(df, SITE)
comb_labs %>% test_sites(function (lab) choose_test(lab, "mis"))
```

### rename

Function to rename the dataset, using crfs.

```{r rename, eval = FALSE}
rename_dataset("./crfs", "old_name", "new_name", 2)
```

* "./crfs" - path to crfs
* "old_name" - variable for names in the dataset, without postfix or prefix
* "new_name" - variable for necessary names, names should be unique
* 2 - a position of a sheet in the excel document, where dmtools can find "old_name" and "new_name"
